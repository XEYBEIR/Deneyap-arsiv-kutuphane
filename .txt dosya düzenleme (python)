#!/usr/bin/env python3
"""
Basit ama kullanışlı bir TXT düzenleyici - Tkinter tabanlı.
Özellikler:
- Yeni, Aç, Kaydet, Farklı Kaydet
- Geri al / Yinele, Kes / Kopyala / Yapıştır
- Bul & Değiştir (kısmi/tek/ tümünü değiştir)
- Satır/sütun durumu, otomatik kaydetme uyarısı
- Satır kaydırma açma/kapama, font büyüklüğü seçimi

Kaydet: python txt_editor.py
"""

import tkinter as tk
from tkinter import ttk, filedialog, simpledialog, messagebox, font
import os

class TextEditor(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("TXT Düzenleyici")
        self.geometry("900x600")

        self.filepath = None
        self._create_widgets()
        self._bind_shortcuts()

    def _create_widgets(self):
        # Menü
        menubar = tk.Menu(self)
        self.config(menu=menubar)

        file_menu = tk.Menu(menubar, tearoff=False)
        file_menu.add_command(label="Yeni", command=self.new_file, accelerator="Ctrl+N")
        file_menu.add_command(label="Aç...", command=self.open_file, accelerator="Ctrl+O")
        file_menu.add_command(label="Kaydet", command=self.save_file, accelerator="Ctrl+S")
        file_menu.add_command(label="Farklı Kaydet...", command=self.save_as)
        file_menu.add_separator()
        file_menu.add_command(label="Çıkış", command=self.on_exit)
        menubar.add_cascade(label="Dosya", menu=file_menu)

        edit_menu = tk.Menu(menubar, tearoff=False)
        edit_menu.add_command(label="Geri Al", command=lambda: self.text.event_generate("<<Undo>>"), accelerator="Ctrl+Z")
        edit_menu.add_command(label="Yinele", command=lambda: self.text.event_generate("<<Redo>>"), accelerator="Ctrl+Y")
        edit_menu.add_separator()
        edit_menu.add_command(label="Kes", command=lambda: self.text.event_generate("<<Cut>>"), accelerator="Ctrl+X")
        edit_menu.add_command(label="Kopyala", command=lambda: self.text.event_generate("<<Copy>>"), accelerator="Ctrl+C")
        edit_menu.add_command(label="Yapıştır", command=lambda: self.text.event_generate("<<Paste>>"), accelerator="Ctrl+V")
        edit_menu.add_separator()
        edit_menu.add_command(label="Bul / Değiştir", command=self.find_replace, accelerator="Ctrl+F")
        menubar.add_cascade(label="Düzen", menu=edit_menu)

        view_menu = tk.Menu(menubar, tearoff=False)
        self.wrap_var = tk.BooleanVar(value=True)
        view_menu.add_checkbutton(label="Satır Kaydırma", variable=self.wrap_var, command=self.toggle_wrap)
        view_menu.add_command(label="Font Boyutu...", command=self.change_font_size)
        menubar.add_cascade(label="Görünüm", menu=view_menu)

        # Araç çubuğu (basit)
        toolbar = ttk.Frame(self)
        toolbar.pack(side=tk.TOP, fill=tk.X)
        ttk.Button(toolbar, text="Yeni", command=self.new_file).pack(side=tk.LEFT, padx=2, pady=2)
        ttk.Button(toolbar, text="Aç", command=self.open_file).pack(side=tk.LEFT, padx=2, pady=2)
        ttk.Button(toolbar, text="Kaydet", command=self.save_file).pack(side=tk.LEFT, padx=2, pady=2)
        ttk.Button(toolbar, text="Bul/Değiştir", command=self.find_replace).pack(side=tk.LEFT, padx=6)

        # Text ve Scrollbar
        self.text_frame = ttk.Frame(self)
        self.text_frame.pack(fill=tk.BOTH, expand=True)

        self.vscroll = ttk.Scrollbar(self.text_frame, orient=tk.VERTICAL)
        self.hscroll = ttk.Scrollbar(self.text_frame, orient=tk.HORIZONTAL)

        self.text = tk.Text(self.text_frame, wrap=tk.WORD, undo=True, yscrollcommand=self.vscroll.set,
                            xscrollcommand=self.hscroll.set)
        self.text.pack(fill=tk.BOTH, expand=True, side=tk.LEFT)

        self.vscroll.config(command=self.text.yview)
        self.vscroll.pack(side=tk.RIGHT, fill=tk.Y)
        self.hscroll.config(command=self.text.xview)
        self.hscroll.pack(side=tk.BOTTOM, fill=tk.X)

        # Font
        default_font = font.nametofont("TkTextFont")
        default_font.configure(size=12)
        self.text.configure(font=default_font)

        # Durum çubuğu
        self.status = ttk.Label(self, text="Yeni dosya — 0 satır, 0 sütun")
        self.status.pack(side=tk.BOTTOM, fill=tk.X)
        self.text.bind("<KeyRelease>", self._update_status)
        self.text.bind("<ButtonRelease>", self._update_status)

    # Dosya işlemleri
    def new_file(self):
        if self._is_modified():
            if not self._ask_save():
                return
        self.text.delete(1.0, tk.END)
        self.filepath = None
        self.title("TXT Düzenleyici - Yeni dosya")
        self._update_status()

    def open_file(self):
        if self._is_modified():
            if not self._ask_save():
                return
        path = filedialog.askopenfilename(filetypes=[("Text files", "*.txt"), ("All files", "*")])
        if not path:
            return
        try:
            with open(path, "r", encoding="utf-8") as f:
                data = f.read()
        except Exception as e:
            messagebox.showerror("Hata", f"Dosya açılamadı:\n{e}")
            return
        self.text.delete(1.0, tk.END)
        self.text.insert(tk.END, data)
        self.filepath = path
        self.title(f"TXT Düzenleyici - {os.path.basename(path)}")
        self._update_status()

    def save_file(self):
        if not self.filepath:
            return self.save_as()
        try:
            with open(self.filepath, "w", encoding="utf-8") as f:
                f.write(self.text.get(1.0, tk.END))
        except Exception as e:
            messagebox.showerror("Hata", f"Kaydedilemedi:\n{e}")
            return
        self._mark_saved()
        messagebox.showinfo("Kaydedildi", "Dosya kaydedildi.")

    def save_as(self):
        path = filedialog.asksaveasfilename(defaultextension=".txt", filetypes=[("Text files", "*.txt"), ("All files", "*")])
        if not path:
            return False
        try:
            with open(path, "w", encoding="utf-8") as f:
                f.write(self.text.get(1.0, tk.END))
        except Exception as e:
            messagebox.showerror("Hata", f"Kaydedilemedi:\n{e}")
            return False
        self.filepath = path
        self.title(f"TXT Düzenleyici - {os.path.basename(path)}")
        self._mark_saved()
        return True

    def on_exit(self):
        if self._is_modified():
            if not self._ask_save():
                return
        self.destroy()

    # Değişiklik kontrolü
    def _is_modified(self):
        # Basit kontrol: metin boş mu veya aynı mı değil
        if not self.text.get(1.0, tk.END).strip():
            return False
        if not self.filepath:
            return True
        try:
            with open(self.filepath, "r", encoding="utf-8") as f:
                current = f.read()
        except Exception:
            return True
        return current != self.text.get(1.0, tk.END)

    def _ask_save(self):
        resp = messagebox.askyesnocancel("Kaydet", "Değişiklikler kaydedilsin mi?")
        if resp is None:
            return False
        if resp:
            return self.save_file()
        return True

    def _mark_saved(self):
        # Basit: burada ek işlem yapılabilir
        pass

    # Bul ve değiştir
    def find_replace(self):
        dialog = FindReplaceDialog(self, self.text)
        self.wait_window(dialog)

    def toggle_wrap(self):
        if self.wrap_var.get():
            self.text.configure(wrap=tk.WORD)
            self.hscroll.pack_forget()
        else:
            self.text.configure(wrap=tk.NONE)
            self.hscroll.pack(side=tk.BOTTOM, fill=tk.X)

    def change_font_size(self):
        try:
            current = font.nametofont("TkTextFont").cget("size")
        except Exception:
            current = 12
        new = simpledialog.askinteger("Font boyutu", "Yeni font boyutu:", initialvalue=current, minvalue=6, maxvalue=48)
        if new:
            font.nametofont("TkTextFont").configure(size=new)

    def _update_status(self, event=None):
        text = self.text
        line = int(text.index(tk.INSERT).split(".")[0])
        col = int(text.index(tk.INSERT).split(".")[1]) + 1
        rows = int(text.index(tk.END).split(".")[0]) - 1
        name = os.path.basename(self.filepath) if self.filepath else "Yeni dosya"
        self.status.config(text=f"{name} — Satır: {line}, Sütun: {col} — Toplam satır: {rows}")

    def _bind_shortcuts(self):
        self.bind_all("<Control-n>", lambda e: self.new_file())
        self.bind_all("<Control-o>", lambda e: self.open_file())
        self.bind_all("<Control-s>", lambda e: self.save_file())
        self.bind_all("<Control-f>", lambda e: self.find_replace())

class FindReplaceDialog(tk.Toplevel):
    def __init__(self, parent, text_widget):
        super().__init__(parent)
        self.title("Bul / Değiştir")
        self.resizable(False, False)
        self.text = text_widget

        ttk.Label(self, text="Bul:").grid(row=0, column=0, sticky=tk.W, padx=6, pady=6)
        self.find_entry = ttk.Entry(self, width=40)
        self.find_entry.grid(row=0, column=1, padx=6, pady=6)
        self.find_entry.focus()

        ttk.Label(self, text="Değiştir:").grid(row=1, column=0, sticky=tk.W, padx=6, pady=6)
        self.replace_entry = ttk.Entry(self, width=40)
        self.replace_entry.grid(row=1, column=1, padx=6, pady=6)

        btn_frame = ttk.Frame(self)
        btn_frame.grid(row=2, column=0, columnspan=2, pady=(0,6))
        ttk.Button(btn_frame, text="Bul", command=self.find_next).pack(side=tk.LEFT, padx=4)
        ttk.Button(btn_frame, text="Tümünü Bul", command=self.find_all).pack(side=tk.LEFT, padx=4)
        ttk.Button(btn_frame, text="Değiştir", command=self.replace_one).pack(side=tk.LEFT, padx=4)
        ttk.Button(btn_frame, text="Tümünü Değiştir", command=self.replace_all).pack(side=tk.LEFT, padx=4)

    def find_next(self):
        needle = self.find_entry.get()
        if not needle:
            return
        start = self.text.index(tk.INSERT)
        idx = self.text.search(needle, start, nocase=True, stopindex=tk.END)
        if not idx:
            messagebox.showinfo("Bulunamadı", "Aranan ifade bulunamadı.")
            return
        end = f"{idx}+{len(needle)}c"
        self.text.tag_remove("sel", "1.0", tk.END)
        self.text.tag_add("sel", idx, end)
        self.text.mark_set(tk.INSERT, end)
        self.text.see(idx)

    def find_all(self):
        needle = self.find_entry.get()
        if not needle:
            return
        self.text.tag_remove("match", "1.0", tk.END)
        idx = "1.0"
        count = 0
        while True:
            idx = self.text.search(needle, idx, nocase=True, stopindex=tk.END)
            if not idx:
                break
            end = f"{idx}+{len(needle)}c"
            self.text.tag_add("match", idx, end)
            idx = end
            count += 1
        if count == 0:
            messagebox.showinfo("Sonuç", "Eşleşme bulunamadı.")
        else:
            messagebox.showinfo("Sonuç", f"{count} eşleşme bulundu.")

    def replace_one(self):
        needle = self.find_entry.get()
        repl = self.replace_entry.get()
        if not needle:
            return
        idx = self.text.search(needle, "1.0", nocase=True, stopindex=tk.END)
        if not idx:
            messagebox.showinfo("Bilgi", "Aranan ifade bulunamadı.")
            return
        end = f"{idx}+{len(needle)}c"
        self.text.delete(idx, end)
        self.text.insert(idx, repl)

    def replace_all(self):
        needle = self.find_entry.get()
        repl = self.replace_entry.get()
        if not needle:
            return
        content = self.text.get("1.0", tk.END)
        new = content.replace(needle, repl)
        self.text.delete("1.0", tk.END)
        self.text.insert("1.0", new)

if __name__ == '__main__':
    app = TextEditor()
    app.mainloop()
